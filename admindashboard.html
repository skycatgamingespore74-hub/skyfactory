<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body { margin:0; font-family:Arial,sans-serif; background:#1e1e2f; color:#fff; }
    header { background:#2b2b4f; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:1.5em; }

    #hamburger { cursor:pointer; font-size:1.5em; display:none; }

    #sidebar { position:fixed; left:0; top:50px; width:200px; bottom:0; background:#2b2b4f; padding:20px; display:flex; flex-direction:column; gap:15px; z-index:2; }
    #sidebar .locked { display:flex; align-items:center; gap:5px; color:#888; cursor:not-allowed; }
    #sidebar button { padding:5px 10px; margin-top:auto; cursor:pointer; background:#ff4d4d; border:none; color:#fff; border-radius:5px; }

    main { margin:20px; margin-left:220px; transition: margin-left 0.3s; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { padding:10px; border:1px solid #444; text-align:left; }
    th { background:#333366; }
    .score-low { color:#ff4d4d; font-weight:bold; }
    .score-medium { color:#ffcc00; font-weight:bold; }
    .score-high { color:#00ff88; font-weight:bold; }

    #charts { display:flex; flex-wrap:wrap; gap:20px; margin-top:20px; }
    .chart-box { flex:1 1 300px; background:#2b2b4f; padding:20px; border-radius:10px; }

    #logs { background:#2b2b4f; padding:20px; border-radius:10px; margin-top:20px; max-height:200px; overflow-y:auto; }

    #loader { position:fixed; inset:0; background:#1e1e2f; display:flex; justify-content:center; align-items:center; font-size:1.5em; z-index:10; }

    @media(max-width:768px){
        #hamburger { display:block; }
        #sidebar { left:-220px; transition:left 0.3s; top:0; height:100%; }
        #sidebar.open { left:0; }
        main { margin-left:0; }
    }
</style>
</head>
<body>

<div id="loader">Chargement...</div>

<header>
    <h1>Dashboard Admin</h1>
    <div id="hamburger">â˜°</div>
</header>

<div id="sidebar">
    <div class="locked">ðŸ”’ Indisponible</div>
    <div class="locked">ðŸ”’ Indisponible</div>
    <div class="locked">ðŸ”’ Indisponible</div>
    <button id="logoutBtn">DÃ©connexion</button>
</div>

<main id="dashboard" style="display:none;">
    <h2>Utilisateurs</h2>
    <table>
        <thead>
            <tr><th>IP / Utilisateur</th><th>Points</th><th>Score comportemental</th></tr>
        </thead>
        <tbody id="usersTable"></tbody>
    </table>

    <h2>Graphiques</h2>
    <div id="charts">
        <div class="chart-box"><canvas id="connectionChart"></canvas></div>
    </div>

    <h2>Logs</h2>
    <div id="logs"></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ==== CONFIG SERVEUR ====
const SERVER_URL = "https://serveur-site-production-97d2.up.railway.app/admin"; // <-- Remplace MON_SERVEUR

// ==== UTILS ====
function scoreClass(points){
    if(points<=30) return 'score-low';
    if(points<=70) return 'score-medium';
    return 'score-high';
}

function getAuthHeaders() {
    return { "sessionid": localStorage.getItem("sessionId") || "" };
}

// ==== SESSION CHECK & LOADER ====
async function checkSession() {
    const res = await fetch(`${SERVER_URL}/session-check`, { headers: getAuthHeaders() });
    if (!res.ok) return false;
    const data = await res.json();
    return data.success;
}

async function initDashboard() {
    const valid = await checkSession();
    if (!valid) { 
        localStorage.removeItem("sessionId");
        window.location.href = "./index.html"; 
        return; 
    }
    document.getElementById("loader").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
    refreshDashboard();
    setInterval(refreshDashboard, 3000);
}

// ==== FETCH SERVEUR ====
async function fetchUsers(){
    const res = await fetch(`${SERVER_URL}/users`, { headers: getAuthHeaders() });
    if (!res.ok) return [];
    const data = await res.json();
    return data.success ? data.users : [];
}

async function fetchLogs(){
    const res = await fetch(`${SERVER_URL}/logs`, { headers: getAuthHeaders() });
    if (!res.ok) return [];
    const data = await res.json();
    return data.success ? data.logs : [];
}

// ==== MISE Ã€ JOUR DASHBOARD ====
function updateUsersTable(users){
    const usersTable = document.getElementById("usersTable");
    usersTable.innerHTML = "";
    users.forEach(u=>{
        const displayName = u.name ? `${u.ip} <${u.name}>` : `${u.ip} (non connectÃ©)`;
        const points = Math.min(100, Math.max(0, u.points));
        const row = document.createElement("tr");
        row.innerHTML = `<td>${displayName}</td><td>${points}</td><td class="${scoreClass(points)}">${points}</td>`;
        usersTable.appendChild(row);
    });
}

function updateLogs(logs){
    const logsDiv = document.getElementById("logs");
    logsDiv.innerHTML = "";
    logs.forEach(l=>{
        const div = document.createElement("div");
        div.textContent = l;
        logsDiv.appendChild(div);
    });
}

// ==== RAFRAÃŽCHIR DASHBOARD ====
async function refreshDashboard(){
    const users = await fetchUsers();
    updateUsersTable(users);

    const logs = await fetchLogs();
    updateLogs(logs);

    const connectionChartData = [users.filter(u=>u.name).length, users.filter(u=>!u.name).length];
    connectionChart.data.datasets[0].data = connectionChartData;
    connectionChart.update();
}

// ==== GRAPHIQUE CONNECTION ====
const connectionCtx = document.getElementById('connectionChart').getContext('2d');
const connectionChart = new Chart(connectionCtx, {
    type: 'doughnut',
    data: { labels:['ConnectÃ©','Non connectÃ©'], datasets:[{ data:[0,0], backgroundColor:['#00ff88','#ff4d4d'] }] },
    options:{ responsive:true }
});

// ==== HAMBURGER MOBILE ====
const hamburger = document.getElementById("hamburger");
const sidebar = document.getElementById("sidebar");
hamburger.addEventListener("click", ()=> sidebar.classList.toggle("open"));

// ==== DÃ‰CONNEXION ====
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
    const res = await fetch(`${SERVER_URL}/disconnect`, { method:"POST", headers:getAuthHeaders() });
    localStorage.removeItem("sessionId");
    window.location.href = "./index.html";
});

// ==== INIT PAGE ====
initDashboard();
</script>

</body>
</html>
